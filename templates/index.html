{% extends "base.html" %}
{% block title %}Task Management{% endblock %}
{% block head %}
{{ super() }}
<!-- Custom Modal -->
<div id="customCategoryModal" class="modal">
    <div class="modal-content">
        <h3>ÎÎ­Î± ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</h3>
        <input type="text" id="custom_category_input" placeholder="Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î½Î­Î±Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚" class="custom-input">
        <div style="margin-top: 10px;">
            <button class="button" onclick="submitCustomCategory()">ÎŸÎš</button>
            <button class="button button-red" onclick="closeCustomCategoryModal()">Î†ÎºÏ…ÏÎ¿</button>
        </div>
    </div>
</div>

<!-- Modal Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î”Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3>Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ task;</h3>
        <div style="margin-top: 10px;">
            <button id="confirmBtn" class="button button-red">ÎÎ±Î¹</button>
            <button id="cancelBtn" class="button">ÎŒÏ‡Î¹</button>
        </div>
    </div>
</div>


<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 2001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border-radius: 10px;
        width: 300px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

        .modal-content h3 {
            margin-bottom: 15px;
        }

    .custom-input {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #e5eaf4 0%, #f6f8fb 100%);
    }

    h1 {
        color: #333;
        text-align: center;
    }

    .task-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .task-card {
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        background-color: white;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: pointer;
    }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .task-title {
        font-weight: bold;
        font-size: 16px;
    }

    .task-client, .task-status {
        margin-top: 4px;
        font-size: 14px;
    }

        .task-status span {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }

    .task-assigned, .task-comment {
        font-size: 14px;
        margin-top: 4px;
        color: #444;
    }

    #taskForm label {
        display: inline-block;
        width: 160px;
        margin-top: 8px;
        vertical-align: top;
        font-weight: bold;
    }

    #taskForm input,
    #taskForm select,
    #taskForm textarea {
        width: calc(100% - 170px);
        padding: 4px;
        margin-top: 6px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

        #taskForm input[type="date"] {
            width: 180px;
        }

    #taskForm button {
        margin-top: 12px;
        margin-right: 10px;
    }

    #filters form {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px 10px;
        margin-bottom: 20px;
    }

    #filters label {
        font-weight: 500;
        margin-right: 4px;
        color: #333;
    }

    #filters select {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
        min-width: 140px;
        background-color: #ccc;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

        /* Hover effect */
        #filters select:hover {
            border-color: #17a2b8;
            box-shadow: 0 0 5px rgba(23, 162, 184, 0.4);
            cursor: pointer;
        }

        /* Focus (click) effect */
        #filters select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.5);
        }

    #filterOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 999;
    }

    #filterPopup {
        display: none;
        position: fixed;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 90%;
        max-width: 500px;
    }

        #filterPopup form label {
            display: block;
            margin-top: 12px;
            font-weight: bold;
        }

        #filterPopup select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

    .Filed {
        background-color: gray;
    }

    .InProgress {
        background-color: orange;
    }

    .Testing {
        background-color: rgb(90, 117, 255);
    }

    .Done {
        background-color: rgb(9, 205, 9);
    }

    .stage-F {
        background-color: gray;
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        margin-right: 4px;
    }

    .stage-I {
        background-color: orange;
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        margin-right: 4px;
    }

    .stage-T {
        background-color: rgb(90, 117, 255);
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        margin-right: 4px;
    }

    .stage-D {
        background-color: rgb(9, 205, 9);
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        margin-right: 4px;
    }

    .task-details {
        margin-top: 10px;
        display: none;
        border-top: 1px solid #ccc;
        padding-top: 10px;
    }

    .task-card.active .task-details {
        display: block;
    }

    .task-details div {
        margin-bottom: 6px;
    }

    .label {
        font-weight: bold;
    }

    .comment-box {
        margin-top: 10px;
    }

    #taskFormContainer {
        display: none;
        position: fixed;
        top: 5%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        z-index: 1000;
        width: 95%;
        max-width: 1000px;
        max-height: 100%;
        overflow-y: auto;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }

    button,
    .button {
        transition: background-color 0.3s ease, transform 0.2s ease;
        background-color: #0000ffda;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 4px 2px;
        text-align: center;
    }

    .button-red {
        background-color: #e81313 !important; /* ÎºÏŒÎºÎºÎ¹Î½Î¿ */
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .button-green {
        background-color: #13b343 !important; /* Ï€ÏÎ¬ÏƒÎ¹Î½Î¿ */
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .button:hover {
        transform: translateY(-1px);
    }

    h1.title-main {
        font-size: 2.1em;
        text-align: center;
        margin-top: 20px;
        margin-bottom: 20px;
        color: #2b2a2a;
        font-weight: 700;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    h2.section-title {
        font-size: 1.5em;
        margin-top: 30px;
        margin-bottom: 10px;
        color: #2f2f2f;
        border-bottom: 2px solid #17a2b8;
        display: inline-block;
        padding-bottom: 5px;
    }

    /* Î’ÎµÎ»Ï„Î¹Ï‰Î¼Î­Î½Î· ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· dropdown */
    select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: #ffffff;
        border: 1px solid #ced4da;
        padding: 8px 16px;
        border-radius: 6px;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        font-size: 14px;
        width: 100%;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="gray"><polygon points="0,0 20,0 10,10"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 10px;
    }

        /* Hover effect */
        select:hover {
            border-color: #18bad3;
            box-shadow: 0 0 5px rgba(23, 162, 184, 0.4);
            background-color: #ffffff;
            cursor: pointer;
        }

        /* Focus effect */
        select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
        }
</style>
  {% endblock %}
  {% block content %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let currentForm = null;

        document.querySelectorAll('.custom-delete-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                currentForm = this;
                document.getElementById('confirmModal').style.display = 'block';
            });
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('confirmModal').style.display = 'none';
            currentForm = null;
        });

        document.getElementById('confirmBtn').addEventListener('click', () => {
            if (currentForm) {
                currentForm.submit();
            }
        });
    });

    function toggleDetails(el, e) {
        if (e && (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.tagName === 'A')) {
            return;
        }
        el.classList.toggle('active');
    }

    function showForm(isEdit = false) {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('taskFormContainer').style.display = 'block';
        document.getElementById('taskForm').reset();
        if (!isEdit) {
            document.getElementById('taskForm').action = '/add';
            document.getElementById('task_id').value = '';
        }
    }

    function hideForm() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('taskFormContainer').style.display = 'none';
    }

    function showFilters() {
        document.getElementById('filterOverlay').style.display = 'block';
        document.getElementById('filterPopup').style.display = 'block';
    }

    function hideFilters() {
        document.getElementById('filterOverlay').style.display = 'none';
        document.getElementById('filterPopup').style.display = 'none';
    }

    function toggleCustomCategory() {
        const dropdown = document.getElementById('category');
        if (dropdown.value === '__custom__') {
            // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î®Ï‚ ÏƒÏ„Î¿ modal
            document.getElementById('custom_category_input').value = '';
            // Î•Î¼Ï†Î±Î½Î¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ modal
            document.getElementById('customCategoryModal').style.display = 'block';
        }
    }

    function closeCustomCategoryModal() {
        document.getElementById('customCategoryModal').style.display = 'none';
        document.getElementById('category').value = '';  // Reset dropdown
    }

    function submitCustomCategory() {
        const value = document.getElementById('custom_category_input').value.trim();
        const dropdown = document.getElementById('category');

        if (value) {
            // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· option Î¼Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Ï„Î¹Î¼Î®, Î±Ï€Î»Î¬ Ï„Î¿ ÎµÏ€Î¹Î»Î­Î³Î¿Ï…Î¼Îµ
            let existing = Array.from(dropdown.options).find(opt => opt.value === value);
            if (!existing) {
                // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Î½Î­Î¿ option Ï€ÏÎ¹Î½ Ï„Î¿ "Î†Î»Î»Î¿..."
                const newOption = document.createElement('option');
                newOption.value = value;
                newOption.textContent = value;

                const otherOption = dropdown.querySelector('option[value="__custom__"]');
                dropdown.insertBefore(newOption, otherOption);
            }

            // ÎšÎ¬Î½Î¿Ï…Î¼Îµ selected Ï„Î¿ Î½Î­Î¿ option
            dropdown.value = value;

            // Î•Î½Î·Î¼ÎµÏÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ ÎºÏÏ…Ï†ÏŒ input Î³Î¹Î± Î½Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÏ‰ÏƒÏ„Î¬
            let hiddenInput = document.getElementById('custom_category');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'custom_category';
                hiddenInput.id = 'custom_category';
                document.getElementById('taskForm').appendChild(hiddenInput);
            }
            hiddenInput.value = value;

            // ÎšÎ»ÎµÎ¯Î½Î¿Ï…Î¼Îµ Ï„Î¿ modal
            document.getElementById('customCategoryModal').style.display = 'none';
        } else {
            alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.");
        }
    }



    function editTask(task) {
        showForm(true);
        document.getElementById('taskForm').action = '/add';  // Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ ÎµÎ´Ï
        document.getElementById('task_id').value = task[0].toString();
        document.getElementById('title').value = task[1];
        document.getElementById('category').value = task[2];
        document.getElementById('client').value = task[3];
        document.getElementById('contact_person').value = task[4];
        document.getElementById('contact_method').value = task[5];
        document.getElementById('status').value = task[6];
        const basicStatuses = ['Filed', 'In Progress', 'Testing', 'Done'];
        if (basicStatuses.includes(task[7].trim())) {
            document.getElementById('status_details').value = '';
        } else {
            document.getElementById('status_details').value = task[7];
        }
        document.getElementById('duration').value = task[8];
        document.getElementById('assigned_to').value = task[9];
        document.getElementById('request_date').value = task[10];
    }

    function advanceStatus(taskId) {
        const taskCard = document.querySelector(`[onclick*="editTask(${taskId}"]`);
        const wasActive = taskCard && taskCard.classList.contains("active");
        fetch(`/advance/${taskId}`)
            .then(() => {
                if (wasActive) {
                    window.location.href = `/?keep_open=${taskId}`;
                } else {
                    window.location.reload();
                }
            });
    }

    function saveComment(taskId) {
        const textarea = document.getElementById(`comment-${taskId}`);
        const comment = textarea.value;

        fetch(`/comment/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ comment })
        }).then(response => {
            if (response.ok) {
                alert("âœ… Î¤Î¿ ÏƒÏ‡ÏŒÎ»Î¹Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.");
            } else {
                alert("âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ ÏƒÏ‡Î¿Î»Î¯Î¿Ï….");
            }
        }).catch(error => {
            console.error("Î£Ï†Î¬Î»Î¼Î±:", error);
            alert("âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ ÏƒÏ‡Î¿Î»Î¯Î¿Ï….");
        });
    }
    function showHistory(taskId) {
        fetch(`/task/${taskId}/history`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector("#historyTable tbody");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</td></tr>`;
                } else {
                    data.forEach(row => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td style="padding:5px;">${row.status}</td>
                            <td style="padding:5px;">${row.date}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                document.getElementById("historyModal").style.display = "block";
            });
    }

    function closeHistory() {
        document.getElementById("historyModal").style.display = "none";
    }

    window.onclick = function (event) {
        const modal = document.getElementById("historyModal");
        if (event.target === modal) {
            closeHistory();
        }
    }
</script>


  </script>
</head>
<body>
    <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·Ï‚ Ï†Î¯Î»Ï„ÏÏ‰Î½ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <button class="button" onclick="showFilters()">
        <i class="fas fa-filter"></i> Î¦Î¯Î»Ï„ÏÎ±
    </button>

    <!-- Overlay ÎºÎ±Î¹ pop-up Ï†Î¯Î»Ï„ÏÏ‰Î½ -->
    <div id="filterOverlay" onclick="hideFilters()"></div>

    <div id="filterPopup">
        <button onclick="hideFilters()" style="
    position: absolute;
    top: 10px;
    right: 10px;
    border: none;
    background: none;
    font-size: 20px;
    cursor: pointer;
    color: #333;
  ">
            âœ–
        </button>
        <form method="GET">
            <label>Î ÎµÎ»Î¬Ï„Î·Ï‚:</label>
            <select name="client">
                <option value="">ÎŒÎ»Î¿Î¹</option>
                {% for c in predefined_clients %}
                <option value="{{ c }}" {% if request.args.get('client')==c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>

            <label>Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:</label>
            <select name="status">
                <option value="">ÎŒÎ»ÎµÏ‚</option>
                {% for status in ['Filed', 'In Progress', 'Testing', 'Done'] %}
                <option value="{{ status }}" {% if request.args.get('status')==status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>

            <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label>
            <select name="category">
                <option value="">ÎŒÎ»ÎµÏ‚</option>
                {% for cat in predefined_categories %}
                <option value="{{ cat }}" {% if request.args.get('category')==cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>

            <div style="margin-top: 20px;">
                <button type="submit" class="button">Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î¦Î¯Î»Ï„ÏÏ‰Î½</button>
                <a class="button button-red" href="/">Î‘Ï€Î±Î»Î¿Î¹Ï†Î® Î¦Î¯Î»Ï„ÏÏ‰Î½</a>
            </div>
        </form>
    </div>

    <div>
        <h2 class="section-title">Tasks</h2>
        <button class="button" onclick="showForm()">
            <i class="fas fa-plus"></i> Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Task
        </button>
        {% if show_completed %}
        <a class="button button-green" href="/">Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î•Î½ÎµÏÎ³ÏÎ½</a>
        {% else %}
        <a class="button button-green" href="/?show_completed=1">Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Ï‰Î½</a>
        {% endif %}
        <a class="button" href="/export" style="background-color: #17a2b8;">
            <i class="fas fa-file-excel"></i> Export Excel
        </a>
        <div class="task-grid">
            <div class="task-grid-header" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; font-weight: bold; background-color: #f0f0f0; padding: 8px; border-radius: 8px;">
                <div>Î¤Î¯Ï„Î»Î¿Ï‚</div>
                <div>Î ÎµÎ»Î¬Ï„Î·Ï‚</div>
                <div>Î‘Î½Î¬Î¸ÎµÏƒÎ· ÏƒÎµ</div>
                <div>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</div>
            </div>
            {% for task in tasks %}
            <div class="task-card {% if not task[11] %}inactive{% endif %}" onclick="toggleDetails(this, event)" style="padding: 8px;">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; align-items: center; gap: 10px;">
                    <div class="task-title">{{ task[1] }}</div> <!-- Î¤Î¯Ï„Î»Î¿Ï‚ -->
                    <div class="task-client">{{ task[3] }}</div> <!-- Î ÎµÎ»Î¬Ï„Î·Ï‚ -->
                    <div class="task-assigned">{{ task[9] }}</div> <!-- Î‘Î½Î¬Î¸ÎµÏƒÎ· ÏƒÎµ -->
                    <div class="task-status"><span class="{{ task[6].replace(' ', '') }}">{{ task[6] }}</span></div> <!-- ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· -->
                </div>

                <!-- Î‘Î½ Î¸ÎµÏ‚ Î½Î± ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹Ï‚ expandable Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ -->
                <div class="task-details">
                    <div><span class="label">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</span> {{ task[2] }}</div>
                    <div><span class="label">Î‘ÏÎ¼ÏŒÎ´Î¹Î¿Ï‚ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</span> {{ task[4] }}</div>
                    <div><span class="label">ÎœÎ­ÏƒÎ¿ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</span> {{ task[5] }}</div>
                    <div><span class="label">Î‘Î½Î¬Î¸ÎµÏƒÎ· ÏƒÎµ:</span> {{ task[9] }}</div>
                    <div><span class="label">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎšÎ±Ï„Î¬Î¸ÎµÏƒÎ·Ï‚ Î‘Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚:</span> {{ task[10]|format_date }}</div>

                    <!-- Î£Ï„Î¬Î´Î¹Î± -->
                    <div>
                        <button class="button" onclick="showHistory({{ task[0] }})">
                            ğŸ“œ Î Î¿ÏÎµÎ¯Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚
                        </button> <br>
                        <div style="margin-bottom: 8px;"></div>
                        <span class="stage-F">Filed</span>
                        {% for stage in task[7].split(',') if stage.strip() %}
                        {% set clean = stage.strip() %}
                        {% if 'filed' in clean.lower() %}
                        {% elif 'in progress' in clean.lower() %}
                        <span class="stage-I">{{ clean }}</span>
                        {% elif 'testing' in clean.lower() %}
                        <span class="stage-T">{{ clean }}</span>
                        {% elif 'done' in clean.lower() %}
                        <span class="stage-D">{{ clean }}</span>
                        {% else %}
                        {{ clean }}
                        {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Î£Ï‡ÏŒÎ»Î¹Î± -->
                    <div class="comment-box">
                        <label>ğŸ—¨ï¸ Î£Ï‡ÏŒÎ»Î¹Î±:</label>
                        <textarea id="comment-{{ task[0] }}" rows="2" style="width:100%" placeholder="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ‡Î¿Î»Î¯Î¿Ï…...">{{ task[12] or '' }}</textarea>
                        <button class="button" onclick="saveComment({{ task[0] }})" style="margin-top: 6px; background-color: #28a745;">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î£Ï‡Î¿Î»Î¯Î¿Ï…</button>
                    </div>

                    <!-- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ -->
                    <div style="margin-top:10px;">
                        <button onclick='event.stopPropagation(); editTask({{ task|tojson|safe }})' class="button" style="background-color: #ffc107; color: black;">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
                        <form method="POST" action="/delete/{{ task[0] }}" class="custom-delete-form" style="display:inline;">
                            <button type="submit" class="button" style="background-color: #dc3545;">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
                        </form>
                        <button onclick="event.stopPropagation(); advanceStatus({{ task[0] }})" class="button" style="background-color: #17a2b8;">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚</button>
                    </div>
                </div>
            </div>

            {% endfor %}
        </div>
    </div>
    <div id="overlay" onclick="hideForm()"></div>
    <div id="taskFormContainer">
        <form method="POST" id="taskForm" action="/add">
            <input type="hidden" name="task_id" id="task_id">

            <div><label>Î¤Î¯Ï„Î»Î¿Ï‚:</label><input name="title" id="title" required></div>
            <div>
                <label>Î ÎµÎ»Î¬Ï„Î·Ï‚:</label>
                <select name="client" id="client">
                    <option value="">Î•Ï€Î¹Î»Î¿Î³Î®</option>
                    {% for c in predefined_clients %}
                    <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label>
                <select name="category" id="category" onchange="toggleCustomCategory()" required>
                    <option value="">Î•Ï€Î¹Î»Î¿Î³Î®</option>
                    {% for cat in predefined_categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                    <option value="__custom__">Î†Î»Î»Î¿...</option>
                </select>
            </div>
            <div id="custom_category_container" style="display: none;">
                <label>Î†Î»Î»Î¿...</label>
                <input type="text" name="custom_category" id="custom_category" class="custom-input">
            </div>
            <div><label>Î‘ÏÎ¼ÏŒÎ´Î¹Î¿Ï‚ ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</label><input name="contact_person" id="contact_person"></div>
            <div>
                <label>Î Î·Î³Î® ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚:</label>
                <select name="contact_method" id="contact_method">
                    <option value="">Î•Ï€Î¹Î»Î¿Î³Î®</option>
                    <option value="Email">Email</option>
                    <option value="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿">Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</option>
                </select>
            </div>
            <div>
                <label>Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:</label>
                <select name="status" id="status">
                    <option value="Filed">Filed</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Testing">Testing</option>
                    <option value="Done">Done</option>
                </select>
            </div>
            <div><label>Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ ÎµÎ¾Î­Î»Î¹Î¾Î·Ï‚:</label><textarea name="status_details" id="status_details"></textarea></div>
            <div><label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± (ÏÏÎµÏ‚):</label><input name="duration" id="duration" type="number" step="0.1"></div>
            <div>
                <label>Î‘Î½Î¬Î¸ÎµÏƒÎ· ÏƒÎµ:</label>
                <select name="assigned_to" id="assigned_to">
                    <option value="">Î•Ï€Î¹Î»Î¿Î³Î®</option>
                    <option value="Kainourgios Alexandros">Kainourgios Alexandros</option>
                    <option value="Gkiokas Nikos">Gkiokas Nikos</option>
                </select>
            </div>
            <div><label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚:</label><input name="request_date" id="request_date" type="date" value="{{ current_date }}"></div>

            <div>
                <button class="button" type="submit">Î¥Ï€Î¿Î²Î¿Î»Î®</button>
                <button class="button" type="button" onclick="hideForm()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
            </div>
        </form>

    </div>
    <div id="historyModal" class="modal">
        <div class="modal-content" style="width:400px;">
            <h3>Î Î¿ÏÎµÎ¯Î± Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚</h3>
            <table id="historyTable" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border-bottom:1px solid #ccc; padding:5px;">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th>
                        <th style="border-bottom:1px solid #ccc; padding:5px;">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div style="margin-top:15px; text-align:right;">
                <button class="button" onclick="closeHistory()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
            </div>
        </div>
    </div>
</body>
</html>
{% endblock %}